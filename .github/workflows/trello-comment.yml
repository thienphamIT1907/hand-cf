name: Comment PR to Trello

on:
  pull_request:
    types: [opened]

jobs:
  comment-to-trello:
    runs-on: ubuntu-latest
    steps:
      - name: Extract Trello Card ID from PR body or title
        id: extract
        run: |
          TITLE="${{ github.event.pull_request.title }}"
          BODY="${{ github.event.pull_request.body }}"
          COMBINED="$TITLE $BODY"
          echo "$COMBINED"

          CARD_ID=$(echo "$COMBINED" | grep -oE '[a-z0-9]{8}' | head -n1)
          
          if [ -z "$CARD_ID" ]; then
            echo "No Trello Card ID found."
            exit 0
          fi
          
          echo "card_id=$CARD_ID" >> $GITHUB_OUTPUT

      - name: Comment on Trello card
        if: steps.extract.outputs.card_id != ''
        run: |
          curl -X POST "https://api.trello.com/1/cards/${{ steps.extract.outputs.card_id }}/actions/comments" \
          -d "key=${{ secrets.TRELLO_API_KEY }}" \
          -d "token=${{ secrets.TRELLO_TOKEN }}" \
          -d "text=GitHub PR [#${{ github.event.pull_request.number }}](${{ github.event.pull_request.html_url }}) created: ${{ github.event.pull_request.title }}"
